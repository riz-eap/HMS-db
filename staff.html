<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Staff — HMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    .section-card { border-radius:12px; padding:18px; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .user-avatar { width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:var(--accent);font-weight:700; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">HMS</a>
      <div class="d-flex align-items-center gap-3 ms-auto" id="userArea"></div>
    </div>
  </nav>

  <main class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><h4>Staff Directory</h4><div class="small-muted">Add, view, and manage hospital staff</div></div>
      <div><button id="refreshStaff" class="btn btn-outline-secondary btn-sm">Refresh</button></div>
    </div>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="section-card">
          <h6>All Staff</h6>
          <div class="table-responsive mt-3">
            <table class="table table-sm" id="staffTable">
              <thead><tr><th>Name</th><th>Role</th><th>Department</th><th>Phone</th><th>Actions</th></tr></thead>
              <tbody><tr><td colspan="5" class="small-muted">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="section-card">
          <h6>Add staff member</h6>
          <form id="addStaffForm">
            <div class="mb-2"><label class="form-label small">Name</label><input id="staffName" class="form-control form-control-sm" required/></div>
            <div class="mb-2"><label class="form-label small">Email</label><input id="staffEmail" type="email" class="form-control form-control-sm"/></div>
            <div class="mb-2"><label class="form-label small">Phone</label><input id="staffPhone" class="form-control form-control-sm"/></div>
            <div class="mb-2"><label class="form-label small">Role</label><input id="staffRole" class="form-control form-control-sm" placeholder="e.g. nurse, receptionist"/></div>
            <div class="mb-2"><label class="form-label small">Department</label><input id="staffDept" class="form-control form-control-sm"/></div>
            <div class="d-grid"><button id="addStaffBtn" class="btn btn-primary btn-sm">Add Staff</button></div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><div class="container">© <span id="yearStaff"></span> HMS</div></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('yearStaff').textContent = new Date().getFullYear();
    const API_BASE = '/api';

    function showUserArea(){ const ua=document.getElementById('userArea'); const raw=localStorage.getItem('hms_user'); if(!raw){ ua.innerHTML='<a class="btn btn-sm btn-outline-primary" href="login.html">Login</a>'; return;} const u=JSON.parse(raw); ua.innerHTML=`<div class="d-flex align-items-center" style="gap:.5rem"><div class="user-avatar">${(u.name||u.email||'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()}</div><div><div style="font-weight:600">${u.name||u.email}</div><div class="small-muted" style="font-size:.8rem">Signed in</div></div></div>`;}
    function authFetch(path, opts={}){ const url = path.startsWith('http')?path:API_BASE.replace(/\/$/,'')+'/'+path.replace(/^\/+/,''); const headers=Object.assign({'Content-Type':'application/json'}, opts.headers||{}); const token=localStorage.getItem('hms_token'); if(token) headers['Authorization']='Bearer '+token; return fetch(url, Object.assign({}, opts, { headers })).then(async res=>{ const t=await res.text().catch(()=>null); try{ const body = t?JSON.parse(t):null; if(!res.ok){ const e = new Error(body && (body.error||body.message)?(body.error||body.message):res.statusText); e.status=res.status; e.body=body; throw e;} return body;}catch(e){ throw e; } });}

    const staffTableBody = document.getElementById('staffTable').querySelector('tbody');

    async function loadStaff(){
      staffTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">Loading...</td></tr>';
      try {
        const staff = await authFetch('/staff').catch(()=>[]);
        if(!staff || staff.length===0){ staffTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">No staff found</td></tr>'; return; }
        staffTableBody.innerHTML = staff.map(s => `<tr><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.role)}</td><td>${escapeHtml(s.department||'')}</td><td>${escapeHtml(s.phone||'')}</td><td><button class="btn btn-sm btn-outline-danger delStaff" data-id="${s.id}">Delete</button></td></tr>`).join('');
      } catch(e){ staffTableBody.innerHTML = '<tr><td colspan="5" class="small-muted">Failed to load</td></tr>'; console.error(e); }
    }

    document.getElementById('addStaffForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const btn = document.getElementById('addStaffBtn');
      btn.disabled = true; btn.textContent = 'Adding...';
      try {
        const payload = { name: document.getElementById('staffName').value.trim(), email: document.getElementById('staffEmail').value.trim(), phone: document.getElementById('staffPhone').value.trim(), role: document.getElementById('staffRole').value.trim(), department: document.getElementById('staffDept').value.trim() };
        await authFetch('/staff', { method: 'POST', body: JSON.stringify(payload) });
        await loadStaff();
        document.getElementById('addStaffForm').reset();
      } catch(e){ alert('Add failed'); console.error(e); }
      btn.disabled = false; btn.textContent = 'Add Staff';
    });

    document.body.addEventListener('click', async (ev) => {
      const d = ev.target.closest('.delStaff'); if (!d) return;
      if (!confirm('Delete staff?')) return;
      try { await authFetch('/staff/' + d.dataset.id, { method: 'DELETE' }); await loadStaff(); } catch(e){ alert('Delete failed'); console.error(e); }
    });

    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    document.getElementById('refreshStaff').addEventListener('click', loadStaff);

    showUserArea();
    loadStaff();
  </script>
</body>
</html>
