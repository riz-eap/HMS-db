<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Hospital Management System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css" />
  <style>
    .user-pill { display:flex; align-items:center; gap:.6rem; }
    .user-avatar { width:40px; height:40px; border-radius:50%; background:#eef2ff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent); }
    .section-card { border-radius:12px; padding:18px; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .small-muted { color:#6b7280; }
  </style>
  <!-- add near top of each page (once) -->
<script>
  // config.js (global)
  // Production backend URL (use your render backend URL). For local dev replace accordingly.
  window.HMS = window.HMS || {};
  // Use absolute backend URL in production:
  window.HMS.API_BASE = window.HMS.API_BASE || 'https://hms-backend-yqjj.onrender.com/api';

  // authFetch will be used by all pages to attach token & handle JSON
  window.HMS.authFetch = async function(path, opts = {}) {
    const base = window.HMS.API_BASE.replace(/\/$/,'');
    const url = path.startsWith('http') ? path : `${base}/${path.replace(/^\/+/,'')}`;
    const token = localStorage.getItem('hms_token');
    const defaultHeaders = {'Content-Type':'application/json'};
    opts.headers = Object.assign(defaultHeaders, opts.headers || {});
    if (token) opts.headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch(url, opts);
    const text = await res.text().catch(()=>null);
    let body = null;
    try { body = text ? JSON.parse(text) : null; } catch(e) { body = text; }
    if (!res.ok) {
      const err = new Error(body && (body.error || body.message) ? (body.error || body.message) : res.statusText);
      err.status = res.status; err.body = body;
      throw err;
    }
    return body;
  };
</script>

</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">HMS</a>

      <div class="d-flex align-items-center gap-3 ms-auto">
        <!-- admin dropdown -->
        <div class="dropdown">
          <a class="d-flex align-items-center text-decoration-none dropdown-toggle" id="adminDropdown" data-bs-toggle="dropdown" href="#" aria-expanded="false" style="gap:.6rem;">
            <div id="adminAvatar" class="user-avatar"></div>
            <div id="adminName" style="font-weight:600"></div>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
            <li><a class="dropdown-item" href="#" id="adminEditProfile">Edit profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" id="adminSignOut">Sign out</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <main class="container mt-4 mb-5">
    <div id="adminContent" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3 class="mb-0">Admin Panel</h3>
          <div class="small-muted">Manage users, doctors, appointments and system settings</div>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-3">
          <div class="section-card">
            <h6>Quick actions</h6>
            <div class="d-grid mt-2">
              <a class="btn btn-outline-primary btn-sm" id="manageUsersBtn" href="#">Manage Users</a>
              <a class="btn btn-outline-secondary btn-sm mt-2" id="manageDoctorsBtn" href="#">Manage Doctors</a>
              <a class="btn btn-outline-success btn-sm mt-2" id="manageAppointmentsBtn" href="#">Appointments</a>
              <a class="btn btn-outline-info btn-sm mt-2" id="manageBillingBtn" href="#">Billing</a>
            </div>
          </div>
        </div>

        <div class="col-lg-9">
          <div class="section-card">
            <h6>Overview</h6>
            <div id="overview" class="mt-2">
              <div class="row">
                <div class="col-md-3"><div class="p-3"><strong id="statUsers">—</strong><div class="small-muted">Users</div></div></div>
                <div class="col-md-3"><div class="p-3"><strong id="statDoctors">—</strong><div class="small-muted">Doctors</div></div></div>
                <div class="col-md-3"><div class="p-3"><strong id="statAppointments">—</strong><div class="small-muted">Appointments</div></div></div>
                <div class="col-md-3"><div class="p-3"><strong id="statBilling">—</strong><div class="small-muted">Bills</div></div></div>
              </div>
            </div>
            <div id="adminMain" class="mt-3">
              <!-- render admin tables/forms here -->
              <div class="small-muted">Select an action on the left to manage entities.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminBlocked" class="text-center mt-5" style="display:none;">
      <h5>Access denied</h5>
      <p class="small-muted">You must be signed in as an administrator to access this page. <a href="admin-login.html">Sign in as admin</a></p>
    </div>
  </main>

  <footer class="site-footer"><div class="container">© <span id="yearAdmin"> </span> HMS</div></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('yearAdmin').textContent = new Date().getFullYear();
    const API_BASE = "https://hms-backend-yqjj.onrender.com/api"; // adjust if needed

    function authFetch(path, opts = {}) {
      const url = path.startsWith('http') ? path : API_BASE.replace(/\/$/,'') + '/' + path.replace(/^\/+/,'');
      const token = localStorage.getItem('hms_token');
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
      if (token) headers['Authorization'] = 'Bearer ' + token;
      return fetch(url, Object.assign({}, opts, { headers })).then(async res => {
        const t = await res.text().catch(()=>null);
        let body = null;
        try { body = t ? JSON.parse(t) : null; } catch(e) { body = t; }
        if (!res.ok) {
          const err = new Error(body && (body.error || body.message) ? (body.error || body.message) : res.statusText);
          err.status = res.status; err.body = body;
          throw err;
        }
        return body;
      });
    }

    // check admin on load
    (async function checkAdmin(){
      try {
        const userRaw = localStorage.getItem('hms_user');
        if (!userRaw) throw new Error('Not signed in');
        const userC = JSON.parse(userRaw);
        // quick role check from localStorage
        if (!String(userC.role || '').toLowerCase().includes('admin')) throw new Error('Not an admin');

        // verify token server-side by calling /auth/me
        const me = await authFetch('/auth/me');
        const serverUser = me && me.user ? me.user : me;
        if (!serverUser || !String(serverUser.role||'').toLowerCase().includes('admin')) throw new Error('Not an admin');

        // ok — show admin UI
        document.getElementById('adminContent').style.display = 'block';

        // populate admin name & avatar
        const adminNameEl = document.getElementById('adminName');
        const adminAvatar = document.getElementById('adminAvatar');
        adminNameEl.textContent = serverUser.name || serverUser.email || 'Admin';
        adminAvatar.textContent = (serverUser.name||serverUser.email||'A').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();

        // Fetch & populate basic overview stats (best-effort; endpoints may vary)
        Promise.allSettled([
          authFetch('/users').catch(()=>[]),
          authFetch('/doctors').catch(()=>[]),
          authFetch('/appointments').catch(()=>[]),
          authFetch('/bills').catch(()=>[])
        ]).then(results => {
          const users = results[0].status==='fulfilled' ? results[0].value : [];
          const docs = results[1].status==='fulfilled' ? results[1].value : [];
          const appts = results[2].status==='fulfilled' ? results[2].value : [];
          const bills = results[3].status==='fulfilled' ? results[3].value : [];

          document.getElementById('statUsers').textContent = (Array.isArray(users)?users.length: (users && users.count) || '-');
          document.getElementById('statDoctors').textContent = (Array.isArray(docs)?docs.length: (docs && docs.count) || '-');
          document.getElementById('statAppointments').textContent = (Array.isArray(appts)?appts.length: (appts && appts.count) || '-');
          document.getElementById('statBilling').textContent = (Array.isArray(bills)?bills.length: (bills && bills.count) || '-');
        });

        // wire admin dropdown actions
        document.getElementById('adminSignOut').addEventListener('click', function(e){
          e.preventDefault();
          localStorage.removeItem('hms_token');
          localStorage.removeItem('hms_user');
          window.location.href = 'admin-login.html';
        });

        document.getElementById('adminEditProfile').addEventListener('click', function(e){
          e.preventDefault();
          // you can implement an edit modal or page
          alert('Edit profile not implemented yet — coming soon');
        });

      } catch (err) {
        console.warn('admin auth fail', err);
        document.getElementById('adminBlocked').style.display = 'block';
        document.getElementById('adminContent').style.display = 'none';
      }
    })();
  </script>
</body>
</html>
