<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Login — HMS</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="assets/css/style.css" />

  <style>
    .auth-card { max-width:520px; margin:60px auto; border-radius:12px; overflow:hidden; }
    .auth-left { padding:28px; }
    .small-muted { color:#6b7280; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">HMS</a>
    </div>
  </nav>

  <main class="container">
    <div class="auth-card card shadow-sm">
      <div class="auth-left">
        <h3 class="mb-1">Admin sign in</h3>
        <p class="small-muted mb-3">Enter administrator credentials to manage the system.</p>

        <form id="adminLoginForm" novalidate>
          <div class="mb-3">
            <label class="form-label small">Email</label>
            <input id="adminEmail" type="email" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label small">Password</label>
            <input id="adminPassword" type="password" class="form-control" required />
          </div>

          <div class="d-grid">
            <button id="adminLoginBtn" class="btn btn-primary" type="submit">Sign in as admin</button>
          </div>

          <div id="adminLoginMsg" class="mt-3" aria-live="polite"></div>
        </form>

        <p class="small-muted mt-3">If you are not an administrator, please use the regular <a href="login.html">login</a> page.</p>
      </div>
    </div>
  </main>

  <footer class="site-footer"><div class="container">© <span id="yearAdminLogin"></span> HMS</div></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('yearAdminLogin').textContent = new Date().getFullYear();
    const API_BASE = "https://hms-backend-yqjj.onrender.com/api"; // change if needed
    const form = document.getElementById('adminLoginForm');
    const msgBox = document.getElementById('adminLoginMsg');
    const btn = document.getElementById('adminLoginBtn');

    function show(msg, kind='info'){
      msgBox.innerHTML = `<div class="alert ${kind==='error'?'alert-danger':'alert-success'} small">${msg}</div>`;
    }

    async function postJson(url, body){
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const text = await res.text();
      try { return { ok: res.ok, status: res.status, body: JSON.parse(text) }; }
      catch(e) { return { ok: res.ok, status: res.status, body: text }; }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgBox.innerHTML = '';
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      if (!email || !password) { show('Email and password are required', 'error'); return; }

      btn.disabled = true; btn.textContent = 'Signing in...';

      try {
        const resp = await postJson(API_BASE + '/auth/login', { email, password });
        if (!resp.ok) {
          let em = 'Login failed';
          if (resp.body && resp.body.error) em = resp.body.error;
          else if (resp.status === 401) em = 'Invalid credentials';
          show(em, 'error');
          btn.disabled = false; btn.textContent = 'Sign in as admin';
          return;
        }

        const data = resp.body;
        const token = data.token || data.accessToken || (data.data && data.data.token);
        const user = data.user || data.data?.user || data;

        if (!user) {
          show('Unexpected response from server', 'error'); console.warn('admin login resp', data);
          btn.disabled = false; btn.textContent = 'Sign in as admin';
          return;
        }

        // Ensure the returned user is an admin
        const role = String(user.role || '').toLowerCase();
        if (!role.includes('admin')) {
          show('Account is not an admin. Use admin credentials.', 'error');
          btn.disabled = false; btn.textContent = 'Sign in as admin';
          return;
        }

        // store token & user
        if (token) localStorage.setItem('hms_token', token);
        localStorage.setItem('hms_user', JSON.stringify(user));

        show('Signed in as admin — redirecting...');
        setTimeout(() => window.location.href = 'admin.html', 700);
      } catch (err) {
        console.error('Admin login err', err);
        show('Network error during login', 'error');
        btn.disabled = false; btn.textContent = 'Sign in as admin';
      }
    });

    // If an admin already logged in, send straight to admin page
    (function checkAlready() {
      try {
        const u = JSON.parse(localStorage.getItem('hms_user') || 'null');
        if (u && String((u.role||'')).toLowerCase().includes('admin')) {
          window.location.href = 'admin.html';
        }
      } catch(e){}
    })();
  </script>
</body>
</html>
