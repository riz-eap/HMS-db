<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rooms — HMS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    .section-card { border-radius:12px; padding:18px; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .user-avatar { width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:var(--accent);font-weight:700; }
    .small-muted { color:#6b7280; font-size:.9rem; }
  </style>
  <!-- add near top of each page (once) -->
<script>
  // config.js (global)
  // Production backend URL (use your render backend URL). For local dev replace accordingly.
  window.HMS = window.HMS || {};
  // Use absolute backend URL in production:
  window.HMS.API_BASE = window.HMS.API_BASE || 'https://hms-backend-yqjj.onrender.com/api';

  // authFetch will be used by all pages to attach token & handle JSON
  window.HMS.authFetch = async function(path, opts = {}) {
    const base = window.HMS.API_BASE.replace(/\/$/,'');
    const url = path.startsWith('http') ? path : `${base}/${path.replace(/^\/+/,'')}`;
    const token = localStorage.getItem('hms_token');
    const defaultHeaders = {'Content-Type':'application/json'};
    opts.headers = Object.assign(defaultHeaders, opts.headers || {});
    if (token) opts.headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch(url, opts);
    const text = await res.text().catch(()=>null);
    let body = null;
    try { body = text ? JSON.parse(text) : null; } catch(e) { body = text; }
    if (!res.ok) {
      const err = new Error(body && (body.error || body.message) ? (body.error || body.message) : res.statusText);
      err.status = res.status; err.body = body;
      throw err;
    }
    return body;
  };
</script>

</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">HMS</a>
      <div class="d-flex align-items-center gap-3 ms-auto">
        <div id="userPill"></div>
      </div>
    </div>
  </nav>

  <main class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><h4>Room Management</h4><div class="small-muted">Create rooms, assign patients, view occupancy</div></div>
      <div>
        <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">Refresh</button>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="section-card">
          <h6>Rooms</h6>
          <div class="table-responsive mt-3">
            <table class="table table-sm" id="roomsTable">
              <thead><tr><th>Room#</th><th>Ward</th><th>Type</th><th>Status</th><th>Patient</th><th>Actions</th></tr></thead>
              <tbody><tr><td colspan="6" class="small-muted">Loading...</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="section-card mt-3">
          <h6>Room Assignments (history)</h6>
          <div id="assignmentsList" class="mt-2 small-muted">Loading...</div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="section-card">
          <h6>Create Room</h6>
          <form id="createRoomForm" class="mt-2">
            <div class="mb-2"><label class="form-label small">Room number</label><input id="roomNumber" class="form-control form-control-sm" required /></div>
            <div class="mb-2"><label class="form-label small">Ward</label><input id="roomWard" class="form-control form-control-sm" /></div>
            <div class="mb-2"><label class="form-label small">Bed / label</label><input id="bedLabel" class="form-control form-control-sm" /></div>
            <div class="mb-2"><label class="form-label small">Type</label><select id="roomType" class="form-select form-select-sm"><option>general</option><option>private</option><option>icu</option></select></div>
            <div class="d-grid"><button class="btn btn-primary btn-sm" id="createRoomBtn">Create Room</button></div>
          </form>
        </div>

        <div class="section-card mt-3">
          <h6>Assign Patient to Room</h6>
          <form id="assignForm" class="mt-2">
            <div class="mb-2"><label class="form-label small">Select Room</label><select id="assignRoomSelect" class="form-select form-select-sm"><option>Loading...</option></select></div>
            <div class="mb-2"><label class="form-label small">Select Patient</label><select id="assignPatientSelect" class="form-select form-select-sm"><option>Loading patients...</option></select></div>
            <div class="mb-2"><label class="form-label small">Reason</label><input id="assignReason" class="form-control form-control-sm"/></div>
            <div class="d-grid"><button id="assignBtn" class="btn btn-success btn-sm">Assign</button></div>
          </form>
          <div class="mt-2 small-muted">To vacate a room, use the Vacate action in the rooms list.</div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><div class="container">© <span id="yearRooms"></span> HMS</div></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('yearRooms').textContent = new Date().getFullYear();
    const API_BASE = "/api"; // adjust if needed

    function showUser() {
      const pill = document.getElementById('userPill');
      const raw = localStorage.getItem('hms_user');
      if (!raw) { pill.innerHTML = '<a class="btn btn-sm btn-outline-primary" href="login.html">Login</a>'; return; }
      const u = JSON.parse(raw);
      pill.innerHTML = `<div class="d-flex align-items-center" style="gap:.5rem"><div class="user-avatar">${(u.name||u.email||'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()}</div><div><div style="font-weight:600">${u.name||u.email}</div><div class="small-muted" style="font-size:.8rem">Signed in</div></div></div>`;
    }

    function authFetch(path, opts={}) {
      const url = path.startsWith('http') ? path : API_BASE.replace(/\/$/,'') + '/' + path.replace(/^\/+/,'');
      const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
      const token = localStorage.getItem('hms_token');
      if (token) headers['Authorization'] = 'Bearer ' + token;
      return fetch(url, Object.assign({}, opts, { headers })).then(async res => {
        const t = await res.text().catch(()=>null);
        try { const body = t?JSON.parse(t):null; if (!res.ok) { const e = new Error(body && (body.error||body.message) ? (body.error||body.message) : res.statusText); e.status=res.status; e.body=body; throw e;} return body; } catch(e){ throw e; }
      });
    }

    // DOM refs
    const roomsTable = document.getElementById('roomsTable').querySelector('tbody');
    const assignmentsList = document.getElementById('assignmentsList');
    const assignRoomSelect = document.getElementById('assignRoomSelect');
    const assignPatientSelect = document.getElementById('assignPatientSelect');

    async function loadRooms() {
      roomsTable.innerHTML = '<tr><td colspan="6" class="small-muted">Loading...</td></tr>';
      try {
        const rooms = await authFetch('/rooms').catch(()=>[]);
        if (!rooms || rooms.length===0) { roomsTable.innerHTML = '<tr><td colspan="6" class="small-muted">No rooms yet</td></tr>'; return; }
        assignRoomSelect.innerHTML = '';
        roomsTable.innerHTML = rooms.map(r=> {
          const patient = r.current_patient_id ? (r.current_patient_name || r.current_patient || 'Patient') : '';
          const actions = r.status === 'occupied' ? `<button class="btn btn-sm btn-outline-danger vacateBtn" data-id="${r.id}">Vacate</button>` : `<button class="btn btn-sm btn-outline-success assignQuickBtn" data-id="${r.id}">Assign</button>`;
          return `<tr>
            <td>${escapeHtml(r.room_number)}</td>
            <td>${escapeHtml(r.ward||'')}</td>
            <td>${escapeHtml(r.room_type||'')}</td>
            <td>${escapeHtml(r.status||'')}</td>
            <td>${patient ? escapeHtml(patient) : '-'}</td>
            <td>${actions}</td>
          </tr>`;
        }).join('');
        rooms.forEach(r => {
          const opt = document.createElement('option'); opt.value = r.id; opt.textContent = `${r.room_number} (${r.ward||''}) - ${r.status}`;
          assignRoomSelect.appendChild(opt);
        });
      } catch (err) {
        roomsTable.innerHTML = '<tr><td colspan="6" class="small-muted">Failed to load rooms</td></tr>';
        console.error(err);
      }
    }

    async function loadAssignments() {
      assignmentsList.innerHTML = 'Loading...';
      try {
        const assigns = await authFetch('/room_assignments').catch(()=>[]);
        if (!assigns || assigns.length===0) { assignmentsList.innerHTML = '<div class="small-muted">No assignments</div>'; return; }
        assignmentsList.innerHTML = assigns.slice(0,30).map(a => `<div class="mb-2"><strong>${escapeHtml(a.room_number||a.room?.room_number||'Room')}</strong> — ${escapeHtml(a.patient_name||a.patient?.name||'')} <div class="small-muted">${new Date(a.admitted_at||a.created_at).toLocaleString()} → ${a.vacated_at ? new Date(a.vacated_at).toLocaleString() : 'ongoing'}</div></div>`).join('');
      } catch(e){ assignmentsList.innerHTML = '<div class="small-muted">Failed to load assignments</div>'; console.error(e); }
    }

    async function loadPatientsToSelect() {
      assignPatientSelect.innerHTML = '<option>Loading patients...</option>';
      try {
        const pts = await authFetch('/patients').catch(()=>[]);
        assignPatientSelect.innerHTML = '';
        if (!pts || pts.length===0) { assignPatientSelect.innerHTML = '<option>No patients</option>'; return; }
        pts.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.textContent = `${p.name || p.email} (${p.id})`; assignPatientSelect.appendChild(o); });
      } catch(e){ assignPatientSelect.innerHTML = '<option>Error loading</option>'; console.error(e); }
    }

    // create room
    document.getElementById('createRoomForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const btn = document.getElementById('createRoomBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      try {
        const body = {
          room_number: document.getElementById('roomNumber').value.trim(),
          ward: document.getElementById('roomWard').value.trim(),
          bed_label: document.getElementById('bedLabel').value.trim(),
          room_type: document.getElementById('roomType').value
        };
        await authFetch('/rooms', { method: 'POST', body: JSON.stringify(body) });
        await loadRooms();
        document.getElementById('createRoomForm').reset();
      } catch(e){ alert('Could not create room'); console.error(e); }
      btn.disabled = false; btn.textContent = 'Create Room';
    });

    // assign room
    document.getElementById('assignForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const btn = document.getElementById('assignBtn');
      btn.disabled = true; btn.textContent = 'Assigning...';
      try {
        const payload = {
          room_id: assignRoomSelect.value,
          patient_id: assignPatientSelect.value,
          reason: document.getElementById('assignReason').value
        };
        await authFetch('/room_assignments', { method: 'POST', body: JSON.stringify(payload) });
        await loadRooms(); await loadAssignments();
        document.getElementById('assignForm').reset();
      } catch(e){ alert('Assign failed'); console.error(e); }
      btn.disabled = false; btn.textContent = 'Assign';
    });

    // delegated actions: vacate / quick assign button
    document.body.addEventListener('click', async (ev) => {
      const vac = ev.target.closest('.vacateBtn');
      if (vac) {
        if (!confirm('Vacate this room?')) return;
        try {
          const id = vac.dataset.id;
          await authFetch(`/rooms/${id}/vacate`, { method: 'POST' }); // endpoint assumed; backend should implement
          await loadRooms(); await loadAssignments();
        } catch(e){ alert('Failed to vacate'); console.error(e); }
      }
      const quick = ev.target.closest('.assignQuickBtn');
      if (quick) {
        const rid = quick.dataset.id;
        assignRoomSelect.value = rid;
        // focus patient select
        assignPatientSelect.focus();
      }
    });

    // helper escape
    function escapeHtml(s){ if (!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // refresh
    document.getElementById('refreshBtn').addEventListener('click', () => { loadRooms(); loadAssignments(); loadPatientsToSelect(); });

    // init
    showUser();
    loadRooms();
    loadAssignments();
    loadPatientsToSelect();
  </script>
</body>
</html>
